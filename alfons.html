<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Alfons Gewaltig</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="mySidebar" class="sidebar">
        <a href="index.html">Agenda</a>
        <a href="#">Characters</a>
        <a href="store.html">Store</a>
        <a href="#">Abilities</a>
    </div>
    <button class="openbtn" onclick="openNav()">☰</button>
    <h1 id="randomColorText">Alfons Gewaltig</h1>

    <h2>Agenda</h2>
    <div id="weekNavigation">
        <button class="nav-button" onclick="changeWeek(-1)">&#10094; Prev Week</button>
        <span id="weekLabel"></span>
        <button class="nav-button" onclick="changeWeek(1)">Next Week &#10095;</button>
    </div>
    
    <div id="dateSelection" style="text-align: center; margin: 20px;">
        <input type="date" id="dateInput" />
        <button class="nav-button" onclick="navigateToDate()">Go</button>
    </div>

    <table id="agendaTable">
        <thead>
            <tr>
                <th>Time/Date</th>
            </tr>
        </thead>
        <tbody>
            <!-- Time slots will be generated by JavaScript -->
        </tbody>
    </table>

<!--     <button id="addYearDataButton">Añadir Días del Año a Firestore</button>
 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc, collection, deleteDoc, query, where, getDocs, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAyt_9YFvhYF_f5adSS1M_FrJ1bQ199VWY",  // Asegúrate de reemplazar esto con tu API key real
            authDomain: "yamanami-dorm.firebaseapp.com",
            projectId: "yamanami-dorm",
            storageBucket: "yamanami-dorm.appspot.com",
            messagingSenderId: "139150495901",
            appId: "1:139150495901:web:7454d8468a90e22a538474",
            measurementId: "G-7M5EGBC3R9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const docRef = doc(db, "agenda", "store-doc-id");

        const pageId = "alfons";

        document.addEventListener('DOMContentLoaded', function () {
            const sidebar = document.getElementById('mySidebar');
            const openBtn = document.querySelector('.openbtn');

            openBtn.addEventListener('click', function () {
                sidebar.style.width = '250px';
            });

            sidebar.addEventListener('mouseleave', function () {
                sidebar.style.width = '0';
            });

            renderAgenda();
            document.querySelector('tbody').addEventListener('input', saveAgendaData);
        });

        const unsubscribe = onSnapshot(docRef, (doc) => {
            if (doc.exists()) {
                console.log("Current data: ", doc.data());
            } else {
                console.log("No such document!");
            }
        }, (error) => {
            console.error("Error fetching document: ", error);
        });

        let currentDate = new Date(localStorage.getItem('${pageId}CurrentDate') || '2024-01-01T00:00:00Z');

        function changeWeek(direction) {
            currentDate.setDate(currentDate.getDate() + (7 * direction));
            localStorage.setItem('${pageId}CurrentDate', currentDate.toISOString());
            renderAgenda();         
        }

        function renderAgenda() {
            updateWeekLabel();
            generateTableHeader();
            generateTableBody();
            loadAgendaData();
        }

        function updateWeekLabel() {
            let weekStart = new Date(currentDate);
            weekStart.setDate(weekStart.getDate() - weekStart.getDay() + 1);
            let weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            document.getElementById('weekLabel').textContent = `${formatDate(weekStart)} - ${formatDate(weekEnd)}`;
        }

        function formatDate(date) {
            return `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
        }

        function generateTableHeader() {
            const headerRow = document.querySelector('thead tr');
            headerRow.innerHTML = '<th>Time/Date</th>';
            const daysOfWeek = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            daysOfWeek.forEach((day, index) => {
                const th = document.createElement('th');
                const date = new Date(currentDate);
                date.setDate(currentDate.getDate() - currentDate.getDay() + 1 + index);
                th.textContent = `${day} ${date.getDate()}/${date.getMonth() + 1}`;
                headerRow.appendChild(th);
            });
        }

        function generateTableBody() {
            const tbody = document.querySelector('tbody');
            tbody.innerHTML = '';
            const timeSlots = ['Morning', 'Afternoon', 'Evening', 'Night'];
            timeSlots.forEach((slot, slotIndex) => {
                const row = document.createElement('tr');
                const th = document.createElement('th');
                th.textContent = slot;
                row.appendChild(th);
                for (let i = 0; i < 7; i++) {
                    const td = document.createElement('td');
                    td.className = 'editable';
                    td.setAttribute('contenteditable', 'true');
                    td.setAttribute('data-slot', slot);
                    const dateOfCell = new Date(currentDate);
                    dateOfCell.setDate(currentDate.getDate() - currentDate.getDay() + 1 + i);
                    td.setAttribute('data-date', dateOfCell.toISOString().substring(0, 10));
                    row.appendChild(td);
                }
                tbody.appendChild(row);
            });
        }

        async function saveAgendaData(event) {
            const cell = event.target;
            const date = cell.getAttribute('data-date');
            const slot = cell.getAttribute('data-slot');
            const value = cell.textContent.trim();
            const agendaRef = doc(db, "agenda", `${date}-${pageId}`);

            try {
                await updateDoc(agendaRef, {
                    [slot]: value
                });
                console.log("Data saved:", date, slot, value);
            } catch (error) {
                console.error("Error saving data:", error);
            }
        }

        async function loadAgendaData() {
            const cells = document.querySelectorAll('td.editable');
            cells.forEach((cell) => {
                const dateOfCell = cell.getAttribute('data-date');
                const slot = cell.getAttribute('data-slot');
                if (dateOfCell && slot) {
                    const docRef = doc(db, "agenda", `${dateOfCell}-${pageId}`);
                    onSnapshot(docRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            cell.textContent = data[slot] || "";
                        } else {
                            console.log("No hay datos para", dateOfCell);
                            cell.textContent = ""; 
                        }
                    }, (error) => {
                        console.error("Error al escuchar los datos de Firestore:", error);
                    });
                } else {
                    console.error("Faltan atributos data-date o data-slot en la celda:", cell);
                }
            });
        }

        async function addDaysOfYearToFirestore(year) {
            const db = getFirestore(app);
            const startDate = new Date(year, 0, 1); 
            const endDate = new Date(year + 1, 0, 0); 

            // Paso 1: Eliminar documentos anteriores del año especificado
            const agendaCollection = collection(db, "agenda");
            const q = query(agendaCollection, where("date", ">=", `${year}-01-01`), where("date", "<=", `${year}-12-31`), where("pageId", "==", pageId));
            const querySnapshot = await getDocs(q);

            for (const docSnapshot of querySnapshot.docs) {
            await deleteDoc(docSnapshot.ref);
            console.log(`Deleted document: ${docSnapshot.id}`);
        }

            // Paso 2: Añadir nuevos documentos
            for (let d = startDate; d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().split('T')[0];
                const docRef = doc(db, "agenda", `${dateStr}-${pageId}`);
                await setDoc(docRef, {
                    date: dateStr,
                    notes: ""
                }, { merge: true }); 
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const addButton = document.getElementById('addYearDataButton');
            if (addButton) {
                addButton.addEventListener('click', function () {
                    const year = prompt("Ingrese el año para agregar los días:");
                    if (year) {
                        addDaysOfYearToFirestore(parseInt(year));
                    }
                });
            }
        });

        function navigateToDate() {
            const dateInput = document.getElementById('dateInput').value;
            if (dateInput) {
                const selectedDate = new Date(dateInput);
                if (selectedDate.toString() !== "Invalid Date") {
                    currentDate = selectedDate;
                    localStorage.setItem('${pageId}CurrentDate', currentDate.toISOString());
                    renderAgenda();
                } else {
                    alert("Fecha inválida. Por favor ingrese una fecha válida.");
                }
            } else {
                alert("Por favor seleccione una fecha.");
            }
        }

        window.navigateToDate = navigateToDate;
        window.changeWeek = changeWeek;
        window.openNav = () => document.getElementById("mySidebar").style.width = "250px";
        window.closeNav = () => document.getElementById("mySidebar").style.width = "0";
    </script>
</body>
</html>
